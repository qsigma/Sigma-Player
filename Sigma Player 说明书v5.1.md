# Sigma Player 说明书
适用于 Sigma Player v5.1 & Sigma Player Pro v5.1

*Sigma Player v5.1 和 Sigma Player Pro v5.1 对文件结构进行了较大调整，建议你下载完整安装包运行。在新上线的迁移助手的帮助下，你可以快捷地将历史版本的资源文件迁移到新版本中。*

## 欢迎使用
### 运行 Sigma Player
- 运行 Sigma Player 前，请确保运行的系统为 win10 及以上版本。
- 解压 Sigma Player 压缩包，在目录中找到后缀为.exe 的文件，右击后选择以管理员身份运行。 
> - 如果直接双击了.exe 文件，则软件会弹出获取管理员权限的窗口，点击确认后会摧毁原先的窗口，生成获取了管理员权限的新窗口。
> - 如果无法打开软件，可能需要你检查互联网连接、暂时关闭 VPN 代理

### Sigma Player 内含物清单

| 软件目录             | 文件名称                              | 说明                          |
|----------------------|---------------------------------------|-------------------------------|
|  -  |Sigma Player (Pro) vx.x.exe                               | 软件本体                      |
| - | Sigma Player 使用说明.pdf              | 软件说明书                    |
| audios               | 风物之诗琴, ...                         | 软件的[内置音源](#内置诗琴)                |
| autosave             | flowsave.txt                           | 存放[流式编曲](#流式编曲)自动保存的文件    |
|                      | mainsave.txt                           | 存放主文本框自动保存的文件    |
|                      | helpersave.txt                         | 存放副文本框自动保存的文件    |
| config               | config.json, ...                       | 软件的配置文件                |
|                      | file_list.txt                          | 存放[在线曲库](#选择琴谱文件)的文件列表，以便快速给出搜索结果|
| icons                | icons.ico, pin.png, ...                | 软件的图标等图片文件          |
| keymap               | ...                                    | 存放[按键映射](#按键映射)脚本             |
| midi                 | ...                                    | 存放用户[导出的midi文件](#导出为Midi)       |
| playlist             | ...                                    | 存放用户定义的播放列表        |
| scripts              | ...                                    | 存放[万向转谱](#万向转谱)脚本             |
| sheets               | ...                                    | 存放曲谱                      |
> 缺失上述文件夹可能导致 Sigma Player 无法正常运行。在不修改文件夹名称的前提下，你可以创建新的文件夹用于存放 midi 文件或其它用途。

### 历史版本迁移助手
从Sigma Player 5.1起，你可以点击软件右上角的 <img width="17" alt="image" src="https://github.com/user-attachments/assets/cd8ee0a3-362a-4aa4-a7bd-346438321a39" />
图标，将历史版本的资源文件迁移到当前版本中。该功能会将你在历史版本中的 `sheets`, `midi`, `playlist`, `scripts`, `keymap`, `config`, `audios`, `autosave` 等文件夹中的内容复制到当前版本的文件夹中。

- 点击【选择文件夹】后，软件会读取你选择的文件夹下，是否有audios等各个文件夹存在，并将存在的选项高亮，供你选择是否迁移。你选择的文件夹须是audios, exe等文件的上一级。
- 如果遇到同名文件，迁移助手会用历史版本的文件覆盖当前版本的文件，除了`config.json`中关于版本号的信息；
- 默认情况下，原位置的文件不会被删除。我们提供了“同时删除整个原软件目录”的选项，但是我们**非常不建议**你冒着丢失其他重要数据的风险选中它。

<img width="378" alt="image" src="https://github.com/user-attachments/assets/b9d3544e-ba5a-4567-881d-200f261e05a6" />


### 验证 Sigma Player Pro
- Sigma Player Pro 包含了 midi 转谱的独家功能以及标准版的全部功能。如果你是 midi 制曲者或者高水平手弹玩家，可以前往[如下问卷地址](https://wjx.cn/vm/e3srfbJ.aspx#)申请使用 Sigma Player Pro。
- 在填写申请问卷前，你需要准备好**活跃平台的账号主页截图、设备的MAC地址和联系邮箱**；如果你的申请审核通过，我们会给你的邮箱发放激活码。
- 如果你获得了 Sigma Player Pro 的使用资格，请在所提交机器码的设备上解压 Sigma Player Pro 的安装包，双击.exe 文件，输入发放的激活码。此后，你可以正常使用，无需再次验证.

> - 发放的激活码仅限本台设备使用，无法在不同的设备上激活。
> - 如果你复制了激活码但是无法正常激活，请试着手动输入；如果发现软件显示的 MAC 地址与你提交的 MAC 地址不一致，请关闭 VPN 后重试。
### 更新版本
Sigma Player Pro v4.2、Sigma Player v4.3 及以上版本配备在线热更新功能，软件会在运行时检测是否有更新可用。如果检测到新版本，软件左上角会出现如下图标：

<img width="415" alt="image" src="https://github.com/user-attachments/assets/73537878-8496-48d2-899f-499699f48991">

点击之后会跳出如下对话框

<img width="445" alt="image" src="https://github.com/user-attachments/assets/18063cfa-3f7e-4212-ae7d-d3d0cc22dc3e">

你可以了解新版本的更新内容，点击按钮下载新版本的 exe 文件，按照对话框的指示，将它放在你现在软件的同位置下，然后删除旧版本 exe 文件。
### 卸载软件
将软件文件夹直接删除即可完成卸载。
> 如果你遇到了删除报错，请尝试右键任务管理器，查看后台进程中是否有残留的 Sigma Player 进程。
### 权限、隐私与账号安全问题
- 为了保证软件的正常运行，你需要提供**管理员权限**，以实现自动演奏功能的正常运行。
- 为了保证软件的正常运行，你需要保证设备**接入互联网**，以获取可用更新和公告。VPN 的开启可能会导致软件无法正常运行。请注意，软件只会从 gitee 的项目中获取信息，而不会上传你的任何信息。
- 为了保证软件的正常功能运作，软件可能会**读取，修改或删除**你的 Sigma Player 文件夹中的琴谱、图标、音源等文件。
- 在自动演奏中，软件会操纵你的**键盘**进行**虚拟输入**。
- Sigma Player 不会修改游戏内数据，因此不会导致任何进行自动演奏的游戏封号，请你放心使用。

### 你的支持
Sigma Player在过去的两年半为爱发电。你的赞助支持是支撑西格玛继续开发的最大动力！欢迎你通过软件交流群881443431或QQ号2640509129对西格玛进行打赏。你的昵称会被记录在【关于软件】的赞助者名单中，你的需求与反馈也会被优先响应。

## 界面说明
### 了解软件的各个界面
当前版本的 Sigma Player 由四个页面构成。

#### 音频中枢
在这个界面无需打开游戏，即可进行手弹练习；同时也是与音频播放相关的所有功能的入口。

<img width="740" alt="image" src="https://github.com/user-attachments/assets/ccfd0637-f1a4-48af-95e2-b17c28e3d114" />



#### 琴谱转换
在这个界面可以编辑琴谱，调用丰富的琴谱格式转换功能，或使用换行、排序等功能按钮。

<img width="740" alt="image" src="https://github.com/user-attachments/assets/5f69cf8c-22da-4925-b668-5fc0423581eb" />



#### 流式编曲
在这个界面可以使用双向同步的文本框和瀑布流，创作自己的作品，或者进行手弹录制。也是 Sigma Player Pro 的 Midi 转谱的入口。

<img width="740" alt="image" src="https://github.com/user-attachments/assets/ef9b0982-f776-4900-aa53-1c89b40676ac" />



#### 关于软件
在这个界面可以查看赞助鸣谢、公告系统、更新日志和快捷链接。

<img width="711" alt="image" src="https://github.com/user-attachments/assets/d5bdc060-e520-4132-815a-c2c01d0b364b" />



### 顶部与底部的常驻 UI
- 顶部的常驻 UI，包含导入琴谱和几个使用软件时的图标按键。

 <img width="377" alt="image" src="https://github.com/user-attachments/assets/3037e4a4-d364-4d07-ba61-db171dc22a11" />



  - **图钉**：点按后会变成<img width="17" alt="image" src="https://github.com/user-attachments/assets/baabc154-8c08-4c21-ab2f-ccd758b1736c">，表示软件窗口具有了置顶的特性；再次点按则取消置顶；
  - **皮肤**：点按后打开自定义主题配置向导。
    > 在部分功能打开时，皮肤按钮不可用。

    <img width="699" alt="image" src="https://github.com/user-attachments/assets/a2b98ee2-ff3f-45a9-af62-88ad134a968a" />

    - 在自定义主题向导中，你可以选择六套预设主题，或者在六套自设主题中创作自己的配色。只需要点击每个色块，然后在选色窗口中选择颜色。
    - 软件上方的 UI 会实时显示当前的效果，方便你查看当前色块应用于哪个位置。
    - 选色窗口提供了丰富的选色支持，包括一个从屏幕上吸取颜色的按钮。
      <img width="1273" alt="截屏2025-01-06 13 26 20" src="https://github.com/user-attachments/assets/df68ecf1-d5f2-4903-91fa-1dfffe17426a" />

  - **刷新**：点按后刷新琴谱目录、检测版本更新。
  - **更新**：当软件在启动时或刷新后检测到GitHub仓库存在更新的版本号，则跳出在线更新。
  - 导入**文件**：从本地文件导入`.mid`或`.txt`文件。
  - 导入**在线曲库**：从[在线曲库](#在线曲库)导入歌曲。
  - **[历史版本迁移助手](#历史版本迁移助手)**：将资源文件从历史版本进行迁移。
- 底部的常驻 UI，包含自动演奏进度条和控制中心。

  <img width="506" alt="image" src="https://github.com/user-attachments/assets/b8633625-77db-45d9-9858-df7bd2fef402">

  
控制中心允许你切换音频输出的模式，具体含义可以在[自动演奏](#自动演奏)章节查阅。

## 自动演奏
> - Sigma Player 原生支持自动演奏 Sigma-呱呱谱格式的琴谱，以及 Midi 文件。对于其它格式的琴谱如何通过琴谱转换实现自动演奏，请参考[琴谱转换](#琴谱转换)章节。
> - 在自动演奏文本琴谱与 Midi 文件时，Sigma Player 均支持速度调节、暂停中止。

### 了解自动演奏的基本用法
#### 选择琴谱文件
首先，你需要将待演奏的琴谱导入 Sigma Player，你可以选取下列任一方式。
- **从顶部下拉菜单中选择**。下拉菜单会读取 sheets 文件夹的文件列表，以及自动保存的两个文件选项。单机任一区域，会调出对应 txt 文件的内容，并显示在软件的文本框中。在软件包中，我们提供了几个示例文件。更多的琴谱资源需要你另行获取。

  <img width="364" alt="image" src="https://github.com/user-attachments/assets/99cc0354-195a-49c9-8470-e62a17ba654d">
 
  > - 单击刷新按钮，会更新琴谱目录。
  > - 如果你的 sheets 文件夹内容过多，无法快捷的找到想要的结果，则可以输入任意关键词，然后再点击下拉，则软件会执行搜索功能，并只显示搜索结果。
- **从浏览文件按钮选择**。浏览文件按钮会弹出选择文件的会话窗口，路径为你上一次选择文件的路径。你可以选择.txt 或.mid 文件导入。
- **直接复制琴谱到文本框**。你可以直接将琴谱复制到【琴谱转换】的文本框中。
- **从在线曲库中选择**。点击软件右上角的<img width="18" alt="image" src="https://github.com/user-attachments/assets/3f633ef2-b95b-4a39-972d-a1d62604372b" />，以打开在线曲库。
  在线曲库会指向此 GitHub 仓库保存的曲谱。你可以在搜索栏搜索关键字，然后在弹出的结果中选择下载或者导入文本框。你还可以点击【给我惊喜】，随机获取十条结果。
  
  <img width="272" alt="image" src="https://github.com/user-attachments/assets/a2101367-a9a7-4326-9769-aa7dd03d7bde" />

  > 由于 GitHub 安全策略限制，你的访问请求不能太频繁。在超过频率限制后，你会收到暂时无法访问的提示，请等待一段时间再使用。你还可以直接运行
  >```shell
  >git clone https://github.com/qsigma/Sigma-Player.git
  >```
  >来克隆整个仓库以避免频繁的在线访问。
  >对于 Sigma Player Pro 用户，我们内置了通往本库的许可密钥，它可以提升你的访问频率限额。


#### 自动演奏的三种输出模式
在底部控制栏，你可以从点按、长音、音频中任意点亮一个模式，并使软件按该模式输出。
> - 当任一模式点亮，软件进入响应状态，此后按 1 即可开始自动演奏。如果你希望退出响应状态，不被正常按键误触发，可以再次点击同一模式，则鼠标移开后控制中心会变为全灰状态。你还可以按下 esc 键达到相同效果。
> - 当练习模式开启时，你无法退出响应状态。但是如果你没有按下练习模式的【开始】，则不必担心按键误触发，详见【练习模式】章节。
- **点按**：当自动演奏读取到对应琴键时，会调用 pynput 库的 tap 方法，短按一下对应虚拟按键并立即松开。这个模式适用于仅由按键触发声音、不依赖松开按键停止发声的游戏内乐器，例如所有的原神乐器。
- **长音**：当自动演奏读取到对应琴键时，会调用 pynput 库的 press 方法，将对应虚拟按键设置为按下状态；在持续到延时符号结束、下一组按键进入，或读取到▲符号时，调用 pynput 的 release 方法，将所有虚拟按键设为抬起状态。这个模式适用于需要由按键的按下、抬起触发声音开始、停止的乐器，例如逆水寒的长笛。
- **音频**：此模式下软件仅会调用自身的音色库，播放对应按键的声音，而不会进行自动演奏。
> 从实现的原理来看，长音与点按彼此不兼容。使用其中一个模式弹奏另一个模式的乐器，都会触发异常效果，因此你需要在演奏前保证选择了正确的输出模式。

#### 如何进行自动演奏
- 在选择任一输出模式，使软件进入响应模式后，按 1 即可触发自动演奏。如果此时演奏区不在 Midi 模式，则会自动演奏文本框中的内容；否则，演奏选中的 Midi 文件。
  > 在默认情况下，按 1 会从曲谱的开头播放；如果你想要从中途开始，可以点按进度条到指定进度后再按 1 开始；对于文本，你还可以在指定位置添加 ■ 后再按 1 开始。
- 在自动演奏过程中，如果模式选择并非音频，则需要将鼠标焦点放置在对应游戏内乐器上。也即，对于原神而言，自动演奏的流程是：打开原琴，根据乐器选择【点按】或【长音】模式，然后点击原琴界面后按 `1`。
- 在自动演奏中，还可以通过快捷键实现中止、暂停、变速等操作。具体指令为：
```text
按下 2：中止演奏；此后可编辑琴谱，按 1 从琴谱开头开始演奏；
按下 3：暂停演奏；在暂停位置生成标识■，此后可编辑琴谱，按 1 从■处开始演奏；
按下 4：加速：变速倍率减少 0.1，至少为 0.5；
按下 5：减速，变速倍率增加 0.1，至多为 2；
按下 6：若启用播放列表的连播选项，则回到上一首歌；
按下 7：若启用播放列表的连播选项，则跳转到下一首歌
```
你可以参考【按键指示】上的状态指示。
- 点击【Alt锁定】，此时这个区域会标红，上述1～7的操作需要同时按下Alt才能触发；如果[按键映射](#按键映射)方案中存在数字1～7，软件会提示你此时也需要同时按下Alt才能触发。在这两种情况下，单独的数字按键触发对应操作失效。但是在任何情况下，你都可以按下Alt+对应数字触发操作。

<img width="353" alt="image" src="https://github.com/user-attachments/assets/e6ae1d8a-13d9-4ebd-83de-04a3c0c7564e" />

<img width="362" alt="image" src="https://github.com/user-attachments/assets/79fbec74-47c4-411b-89d5-18bb2a81abbb" />

<img width="363" alt="image" src="https://github.com/user-attachments/assets/632774f4-fb9d-4bce-b94e-d1738f5e21e0" />


### 按键映射
你可以在音频中枢标签页新建或者切换一个按键映射方案。

<img width="361" alt="image" src="https://github.com/user-attachments/assets/3344bf6d-e95b-488d-97bd-abc3175f1216" />

<img width="365" alt="image" src="https://github.com/user-attachments/assets/6682d37e-6e82-41bb-8848-62491d84e881" />

- 按键映射只对自动演奏的三个模式和内置诗琴生效，不会修改真实的按键映射。
- 输入字符可以是任意 1 长度的**小写**字母或汉字或字符，或在它的前面添加 #。字符不可以包含：`+ - = · 《》 【】 ▲`；
- 冲突的输入字符会标红提示；
- 要设置映射为的按键，点按按钮后，按钮会变绿；此时在键盘上按下你想要修改的按键即可。注意，如果你设定了回车键，需要移开鼠标后再按一次。

#### 黑键支持
在 Sigma Player v5.0 版本，自动演奏、Midi 转谱、Midi 播放都支持了读取黑键。Sigma Player 谱中的黑键和普通键位的表示汇总如下：

| i \ 12i+j+1/j | 1   | 2   | 3   | 4   | 5   | 6   | 7   | 8   | 9   | 10  | 11  | 12  |
| ----------------------- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 1                       | 一   | \#一 | 二   | \#二 | 三   | 四   | \#四 | 五   | \#五 | 六   | \#六 | 七   |
| 2                       | Z   | \#Z | X   | \#X | C   | V   | \#V | B   | \#B | N   | \#N | M   |
| 3                       | A   | \#A | S   | \#S | D   | F   | \#F | G   | \#G | H   | \#H | J   |
| 4                       | Q   | \#Q | W   | \#W | E   | R   | \#R | T   | \#T | Y   | \#Y | U   |
| 5                       | 壹   | \#壹 | 贰   | \#贰 | 叁   | 肆   | \#肆 | 伍   | \#伍 | 陆   | \#陆 | 柒   |

- Midi 播放提供了黑键“保留”选项，可以将黑键的键位映射到对应的音调。
- Midi 转谱也提供了黑键“保留”选项，可以将带 # 的字符输出到转出文本中。
- Midi 导出和自动演奏也支持读取黑键字符。想要在支持黑键的乐器中输出，需要为这些按键适配一套按键映射规则。

### Midi 文件的自动演奏
想要自动演奏 Midi 文件，需要点按浏览文件按钮，将文件类型选为.mid。此时会弹出 Midi 区的 UI，软件进入 Midi 模式。此后，自动演奏的各种操作与文本琴谱的完全一致。

<img width="472" alt="image" src="https://github.com/user-attachments/assets/8c171246-3ab6-4984-8524-eac1e3055f69">

由于无法获知 Midi 文件的调式，我们会在每个调式下计算黑键的个数，并取数量最小的那个方案作为 C 调。在 Midi 区你可以对调式进行进一步的配置。
- 点击最右侧的按键，可以选择在当前定调下，黑键音符的处理方法。可以在黑键靠上、黑键靠下、黑键略去中选择。
- 点击右侧倒数第二个数字，可以修改调式
```
如果想要在软件自动配置的调式上增加一个八度，则在输入的数值上减 12；
如果想要增加一个调，则在输入的数值上减 1，以此类推。
```

### 播放列表
点击【播放列表】按钮，你可以在生成的窗口中新建播放列表，以实现歌曲的连续播放。

<img width="291" alt="image" src="https://github.com/user-attachments/assets/06224e97-70b6-4fbe-b03e-1ae1874c8b9c" />

- 页面提供了播放列表重命名、切换、新建、删除播放列表的功能。在新增歌曲时，你可以直接选择多个`.txt`或`.mid`文件；你可以对每一个条目进行上移、下移、删除、导入操作。
- 在你修改了播放列表中记录的文件的文件名或者路径，需要重新将该文件加入播放列表。如果你仅是修改了文件的内容，则无须担心。
- 播放列表提供了【不启用连播】【顺序播放】【随机播放】【列表循环】【单曲循环】等连播选项。
- 在你对一首歌曲点击【导入】按钮时，它会被导入。如果此时连播模式不是【不启用连播】，则该按钮会变绿。则会改变接下来歌曲的播放顺序：
  - 如果是【顺序播放】【列表循环】，则接下来会开始播放此歌曲之后的列表歌曲；
  - 如果是【随机播放】，会在播放这首歌后重新打乱整个播放列表除了这首歌曲外所有歌曲的播放顺序；
  - 如果是【单曲循环】，会循环播放当前歌曲。
- 在上一条中，如果导入按钮呈现绿色，则此时你更改的乐器、按键映射方案、Midi文件的黑键策略和定调都会记录到这个播放列表的这首歌曲中。在一首歌曲第一次从播放列表导入到待演奏时，Midi文件的黑键策略和定调会分别选取你的设定和默认定调值；乐器和按键映射方案会选取你当前的设定值。
- 受限于Python性能，在你导入超过100首文件后，可能歌曲列表的滚动会略微卡顿。


### 内置诗琴
- 如果在控制中心的输出模式选择了【音频】，且保持软件的页面在【音频中枢】页面，则可以将软件变成原琴模拟器。按下对应按键时，软件顶部的对应琴键会发生变色

  <img width="529" alt="image" src="https://github.com/user-attachments/assets/9478dec4-e345-416e-8b1b-474b435f3c66">

  - 在 Sigma Player v5.0, 我们支持了 SF2 音源文件。你可以自行导入 SF2 或传统音频音源文件。如果你的 SF2 文件中设置了延音，Sigma Player 可以在内置诗琴手弹演奏、流式编曲等地方正确地应用它们。
  - 对于音源文件，可以在软件音频中枢页面左上角点击【乐器配置】，进行乐器的快捷重命名以适配 Sigma Player。在全量软件包中，你可以调用 Librosa 库分析音源频率，快捷获取命名建议。
    <img width="658" alt="image" src="https://github.com/user-attachments/assets/74d6dc61-d633-41c0-949b-162d2f3915b9" />
  - SF2 音源需要自行下载后导入。下载入口为本仓库的 release, 或者软件交流群881443431。
- 打开【启用延时】，则会在按键之后延迟一段时间再播放音频。这是为了模拟游戏中佩戴蓝牙耳机可能造成的延迟。默认值为 175ms。

  <img width="318" alt="image" src="https://github.com/user-attachments/assets/891abd33-3068-4004-bdd6-0829ba311d19">

- 你可以启用【节拍器】以辅助你的手弹演奏。点击【节拍器】按钮，设定播放速度，然后用A, S输入你希望的节奏型，点击【启用】，即可开启/关闭节拍器。此功能需要你拥有**SF2|荒泷豪鼓**。

### 自动演奏的动态效果
在Sigma Player 5.1版本，你可以启用【瀑布流】或【演奏动效】。
- 在选择【音频】输出模式时，点击【瀑布流】按钮，可以在生成音频的同时在对应的键位生成瀑布流；这个效果同样对在软件中手弹演奏生效；仅SF2音源可以实现正常的瀑布流效果。
  
  ![image](https://github.com/user-attachments/assets/40ec64fe-b9a0-47f6-a3f7-6b1c6d0fb99c)

- 【演奏动效】按钮会在自动演奏时，实时高亮当前正在演奏的内容。请注意这个功能可能引起性能的压力，进而减慢播放进度。为了改善这一点，你可以使用[换行](#自动换行)以避免一行文本有过长内容。

### 自动演奏的使用道德规范
自动演奏让手弹技术尚不精通的玩家也可以在游戏中与好友聆听高难度的音乐，然而你需要保持诚信，不可以用 Sigma Player 冒充手弹玩家，也要充分尊重联机房间中反感脚本的玩家。

为了防止用户使用脚本在手弹比赛中作弊，Sigma Player 在自动演奏时会在每个虚拟按键后附加一个 k 键，它可以作为反作弊软件检测的依据。你可以通过按键映射将 k 修改为其他按键。
### 自动演奏中可能的异常排查
- **按 1 后按键指示区有响应，但是没有触发自动演奏**：
查看鼠标焦点是否在游戏乐器中，或是否输入法选择了中文，或是否对长音类乐器选择了点按输出。
- **按 1 后按键指示区无响应**：
这可能是一个 bug。你可以退出响应模式再重新进入，或退出软件再重新进入。如果依然无法解决请向我报告问题。
- **按 1 后播放速度飞快，或有其它效果异常**：
如果你导入了非 Sigma-呱呱谱，需要使用【琴谱转换】自动添加延时符号，然后再进行自动演奏。如果速度正常，但部分地方效果异常，检查是否对点按类乐器选择了长音出。

## Sigma-呱呱谱格式说明 
这一节将介绍 Sigma-呱呱谱的格式，方便你自己进行琴谱的撰写。

Sigma-呱呱谱以延时符号和按键作为主体，不强制要求添加括号，兼具了手弹可读性和脚本可读性。

Sigma-呱呱谱以**呱呱能有什么坏心思**的脚本谱记谱格式为蓝本，且对它完全兼容。然而，Sigma-呱呱谱有局部变速、多音轨、休止符、黑键等其它特性，因此本说明书只讨论 Sigma-呱呱谱的特性，它无法完全适用于呱呱的脚本。

### 音符记号
与原琴一致，我们用键盘上的 `Z~M, A~J, Q~U` 表达 C2 至 B4 的 21 个非黑键音符；在流式编曲与 Midi 转谱中，我们额外预留了 C1 至 B1, C5 至 B5 的两个八度，它们分别用汉字`一~七`， `壹~柒`表示。含这些汉字的琴谱，会在支持的音频输出模式中播放，或导入流式编曲的对应位置。
此外我们还用 \# 标记了黑键。具体对应关系参见[黑键支持](#黑键支持)。
### 延时符号与基本逻辑
- 琴谱中定义了如下四种延时符号 `+ - = ·`。程序顺序读取到延时符号时，会停顿等待一段时间。如果记 = 的停顿时间为 X，则相对地：

  |符号|·|=|-|+|
  |---|---|---|--|--|
  |停顿时间|X/3|X|2X|4X|

  也即如果你将+视为四分音符，则-是八分音符，=是十六分音符。 · 是在出现三连音、琶音等特殊情形时使用的符号，不应作为编谱时的基准符号。
- 假设我们不考虑 X 的取值，那么软件自动演奏的基本逻辑是，读取到延时符号，停顿对应的 X 的倍数；读到连贯的几个字母，则同时将它们按下。
> 在呱呱谱中，没有 · 的记号。你需要将它替换掉，或者修改整个节奏的尺度。
### 速度设定
速度设定用来规定上文中的 X 的值。在琴谱开头时，需要用`《》`标定演奏速度。书名号
内的数值为 + 停顿的时间（以秒为单位），你可以用 60/bpm 进行简单的换算。
> 60/bpm 得到的换算结果可能与实际相差一个整数倍，取决于你选取哪个延时符号作为四分音符。

- **局部变速**：如果在演奏中途，节奏发生了变化，你可以用新的《》标记新的演奏速度。则此后的所有文本，都会按照这个新的《》进行演奏。
- **速度锁**：如果你的谱子没有标记速度，则会默认赋予 0.2 的速度。
- **自动演奏中的临时速度变换**：【按键指示区】在 4 5 之间的数值指示了你在自动演奏时通过 4 5 得到的临时相对速度倍率，范围在 0.5~5 之间，它与原始速度是乘算关系。在演奏中止后，这个倍率会回到 1.0。
### 其它符号的说明
以下符号发挥了特定的功能，它们并不是强制要求出现的。
- 休止符 `▲` ：用于长音演奏中提前结束某组音。一般穿插在一大串+之间。
- 歌词或注释 `【】` ：在【】内的内容不会触发软件的任何效果，你可以填入歌词或注释。
- 暂停 `■` ：在自动演奏按下【3 暂停】时，会在暂停的位置生成一个■，指示暂停的位置；你可以自行修改■的位置，来改变演奏开始的位置。演奏开始后会清空所有的■。
- 音轨 `|` ：用 | 来记录同一位置的多音轨（若同一位置第一音轨有 AC，第三音轨有 B，则记为 AC||B；若第一音轨有 AC，第二音轨有 D，第四音轨有 E，记为 AC|D||E，以此类推。多音轨只会在流式编曲触发特殊效果，在自动演奏中软件会无视 | ，将谱子视为单音轨乐曲，详见【流式编曲】章节。
- 小节 `/` ：用于划分节拍。在流式编曲中会在相应位置生成节拍线，详见[流式编曲](#流式编曲) [琴谱转换](#琴谱转换)章节。
- 标记 `□` ：在流式编曲中会在相应位置生成标记，详见[流式编曲](#流式编曲)章节。
- 黑键 `#`：与后面的字符形成黑键，以适配 Midi 导出或按键映射下的自动演奏。

我们鼓励大家按 Sigma-呱呱谱的格式自行撰写琴谱，或通过 Sigma Player 的琴谱转换功能将特定类型的琴谱转换为 Sigma-呱呱谱。但是为了保证正确性，依然优先推荐大家使用脚本内置的样例谱和后续本人更新的其他琴谱。

以下是两个Sigma-呱呱谱示例。你可以阅读【琴谱转换】了解如何排版，提升琴谱可读性。

<img width="703" alt="image" src="https://github.com/user-attachments/assets/0ae657cc-1aa8-4abc-83d7-5d59ee388a6b">

## 琴谱转换 
### 琴谱转换基本操作
将琴谱输入文本框，从下拉列表选择输入和输出格式，点击【转换】按钮。

<img width="603" alt="image" src="https://github.com/user-attachments/assets/7455175e-1b5d-47c6-b963-2acc4376858d">

为了防止转换卡顿，方便批量操作，Sigma Player 有直接转换文件的功能。右击【转换】，在弹出的子窗口中操作即可。
> 选择的文件必须是 txt 格式，输出的文件在输入文件的同目录，名称为【原文件_输入格式_输出格式.txt】。

Sigma Player 在新版本继续推进琴谱转换功能的完善。希望能借此工具推进 b 站原琴区各类型琴谱的统一，让复杂的脚本谱具有可读性，让不同格式的谱子可以使用一个软件进行演奏。

我鄙视部分开发者吹嘘卖弄自己功能有限、生态封闭、支持性差的软件的行为。
### Sigma-呱呱谱转指尖谱/键盘谱
通过这个模式增加脚本谱的可读性。用户可以在谱子中用/划定第一个小节，点击转换后将自动划分小节，并给相连的音加上括号。

此按钮支持反复点按，每次都将依据第一小节进行重排，以方便用户修改某个小节中的节奏。

用户可以将结果中的+等符号自行替换成空格等，但替换后不支持反复点按转换按钮。

**例1**：标定两个斜杠，触发小节划分和括号标注。三例中琴谱均来自@dr_sigma

<img width="652" alt="image" src="https://github.com/user-attachments/assets/af5c691c-6bcb-43be-9604-e9e72b8e31a8">

**例2**：删去 B 前的斜杠，重新排版，触发小节划分。

<img width="674" alt="image" src="https://github.com/user-attachments/assets/1b480231-00da-4ac8-b1d5-eddf0306025c">

**例3**：不加斜杠，触发括号标注。

<img width="644" alt="image" src="https://github.com/user-attachments/assets/d95d473b-cd58-46ed-b9cd-dd7083d48c72">

### 指尖谱转 Sigma-呱呱谱
手弹谱可以交给脚本演奏！Sigma Player 会根据每个小节内音符（及空格，空格可以换为L）的多少均分小节内的时间。由于本谱是手弹谱，所以转换成脚本谱后效果尚可但节奏仍有差错。与指尖谱类似的脚本谱同样支持在这里转换。

如果原谱中没有数字，用户需要自行标定速度；如果原谱中有数字，将自动嵌套《》。

> 请注意，手弹谱演奏必须先进行琴谱转换！

**例4**：来自@指尖灬旋律丿；《0.2》为用户自行标定的速度。

<img width="687" alt="image" src="https://github.com/user-attachments/assets/6b66bcd9-a901-4499-a556-ba5aba723eed">

**例5**：（琴谱来自@旋律透明），自带速度，未做任何补充更改。

<img width="672" alt="image" src="https://github.com/user-attachments/assets/531c2e8f-20fa-4792-94d0-3374f4abba89">

**例6**：若琴谱中没有/，识别()，[]和【】，后两者为琶音标记；默认琶音外赋+，琶音内赋=。

<img width="647" alt="image" src="https://github.com/user-attachments/assets/a53d39d5-9bf5-45ad-bc47-86a65e79c4de">

### Genshin music 谱转 Sigma-呱呱谱
Sigma Player 鼓励你使用 [https://specy.github.io/genshinMusic/#/Composer](Genshin Music Nightly) 制谱，且提供转换功能。在网站页面点击 download，在 json 文件中选取 columns 后面的内容
即可转换。需要自定速度。

**例7**：

<img width="668" alt="image" src="https://github.com/user-attachments/assets/817df1e8-2016-497c-b489-e49a0f819635">

### 指尖谱或键盘谱转数字谱；“ ”转数字谱

**（接例4）**: 如果输入选择空档，将进行暴力替换，琴谱中有+ -符号的情况下请谨慎操作。

<img width="361" alt="image" src="https://github.com/user-attachments/assets/7911e182-f31a-447e-94c5-a12aa492cf58">

### Sigma-呱呱谱转数字谱
**（接例1）** 保留了/排版功能，删去了延时符号

<img width="676" alt="image" src="https://github.com/user-attachments/assets/733a249c-1180-4431-b127-b36132e57958">

### Sigma-呱呱谱转 js 谱
Js 谱可以用来在移动端自动演奏。将带速度标记的 Sigma-呱呱谱输出为 js 谱

**例8**：

<img width="650" alt="image" src="https://github.com/user-attachments/assets/8c51814f-8719-4812-9e9a-852772a6bb3e">

### js 谱转 Sigma-呱呱谱
为了更好的拟合 js 中的整数值停顿时长，我们独家搭载了 Sigma New-Beat 2.0 节奏拟合算法。点击转换后，可以调节预期输出的精确度/简洁性权重，并查看实时效果。

**例9**：

<img width="666" alt="image" src="https://github.com/user-attachments/assets/b7e06f3c-f076-4580-b034-d2012001a85f">

> Sigma Player 内置的其他输入输出组合欢迎用户自行探寻！此外，Sigma Player 将继续推进琴谱格式的转换，有其他 up 主的琴谱转换需求的，在得到 up 授权之后欢迎与我交流！
### 琴谱转换便携功能
#### 自动换行
点击换行，按照每行的斜杠数进行换行。输入 0 则代表不进行换行。【直接转换文件】中也有对应选项。

<img width="603" alt="image" src="https://github.com/user-attachments/assets/ae17c402-b5e0-47ef-b429-735a730a56e9">

#### 琴谱排序
点击【排序】启用琴谱排序，它可以将琴谱中的音符按音调高低进行排序，方便用户在手弹时找到主旋律，契合自身弹奏习惯。我们给出了升降序、依赖括号或是依赖延时符号共四种模式供用户选择。

<img width="400" alt="image" src="https://github.com/user-attachments/assets/dcfa886b-0ec6-4b8a-b14d-d5d70fe39911">

#### 快捷输入
你可以用`Alt+Q/W/E/R/T/Y/U/I/O/P`来在主文本框、副文本框、流式编曲文本框中的光标处快捷插入自定义的符号或短语。在琴谱转换页面，你可以看到当前的自定义短语并修改它们。你可以在副文本框中看到他们但你无法在此处进行编辑。

<img width="422" alt="image" src="https://github.com/user-attachments/assets/5c65ef99-3c25-4c4e-af17-f6ec1efdf0e8" />


#### 副文本框
在音频中枢页面点击【副文本框】按钮，即可弹出一个独立文本框，你可以用它自由放置文本。它支持自动保存、万向转谱快捷键、快捷输入、置顶等功能和选项。

<img width="512" alt="image" src="https://github.com/user-attachments/assets/73d2b90a-cfe9-4b62-b377-9eaf5f67632e" />


### 万向转谱
你可以通过万向转谱实现自定义的转谱方案，例如适配其他 up 主的记谱格式，用正则表达式添加休止符的方法修复长音演奏异常问题，或实现打谱自动添加小节和括号。

<img width="883" alt="image" src="https://github.com/user-attachments/assets/42819c23-9c40-4f52-b66e-9e174bb132b5" />

- 像 PPT 动画一样编辑或移动你的每一步指令。
- 点击【切换】，切换脚本；或者用【新建】【删除】管理脚本。
- 点击【执行】，作用于主文本框，或点击【选项】，设置是否自动执行。
- 点击【预览】，在左侧输入文本，在右侧查看效果。
- (Pro 独享) 点击【预览】，打开批量转换窗口。将想要转换的曲谱或者文件夹拖拽进弹出的窗口，即可批量转换。**注意：为了保证数据安全，避免可能的错误导致琴谱资源被全部破坏，请先备份后再进行批量转换**

万向转谱提供了如下基础操作：

<img width="673" alt="image" src="https://github.com/user-attachments/assets/faf25b1e-140a-40e3-bb85-d2394508d593" />

- 替换：在单个步骤中**同时**应用你指定的替换逻辑。例如，在一步中设置了 A 替换为 B, B 替换为 A，则 BBAA 会被替换为 AABB。
- 正则替换：利用正则表达式和反向捕获组实现复杂的替换功能。关于正则表达式，详见[这个教程](https://www.runoob.com/regexp/regexp-tutorial.html)
- 内置琴谱转换函数：调用软件自带的转谱函数。
- 自定义脚本：调用自定义脚本，保持引用或者直接复制。
- 排序、换行：调用软件自带的功能模块。



### 自动保存
每 5 秒，Sigma Player 会将主文本框的内容保存至 `autosave/mainsave.txt`，将副文本框的内容保存着 `autosave/helpersave.txt`；自动保存仅在主文本框内容非空时触发。如果你遇到软件闪退未来得及保存，可以前去该目录查看，或重新打开软件，选择琴谱中下拉选择【琴谱转换自动保存】即可。

### 导出为 Midi
Sigma Player Pro 提供了导出为 Midi 的选项。只需设定导出文件的名字，即可导出为 Midi 文件。支持 Sigma-呱呱谱的所有语法，包活黑键、音轨分隔符、局部变速、休止符等。

## 练习模式 
### 打开练习模式
Sigma player v3.0 加入了练习模式。练习模式的入口在音频中枢界面；打开后，会弹出练习模式的窗口，练习模式窗口处于置顶位置。主页面中文本框内的琴谱会被按换行符、变速符号《》进行切分，并将当前行和下一行分别填入练习模式的窗口内。通过这种方式，琴谱以歌词的形式呈现。

<img width="378" alt="image" src="https://github.com/user-attachments/assets/da8d64bc-d821-4a12-a8f8-15fb114c3ed8">

> 打开练习模式后，对应按钮变绿。练习模式打开时，无法触发主文本框的自动演奏输出，且控制中心的模式改为指示练习模式窗口的对应模式输出。

练习模式中更改的内容在**不开启编辑按钮时不会保存**。大规模的更改，请退出练习模式，更改好之后再次打开练习模式。
### 练习模式界面与功能说明

<img width="677" alt="image" src="https://github.com/user-attachments/assets/9ea3ad63-f1ec-4986-ac17-ea32b85d7351">

练习模式的窗口有八个按钮和一根速度滑动条。
- 左侧四个按钮用来调节歌词位置：
  - **重置**：回到第一句；
  - **上句**：回到上一句；在选中窗口时可以按 `←` 触发；任何时候都可以按 `7` 触发；
  - **下句**：进入下一句；在选中窗口时可以按 `→` 触发；任何时候都可以按 `8` 或者`空格Space`触发；
    > 为防止误触，点击【开始】后且不在播放时再使用空格；
  - 标记：点击后变为橙色并记忆标记的句子，直到练习模式关闭；按 `ctrl+7`，`ctrl+8` 可以方便地向前/向后跳转到对应标记的句子。
    > 请注意，歌词位置是一个全局变量，不会随窗口关闭而重置，故用户选择新曲子导入后要手动重置歌词
- 右侧四个按钮用来开启练习模式或者进行编辑：
  - **跟弹**：点击后变红，表示此时软件按照控制中心的选定模式参与演奏；再次点击后变蓝；蓝色表示软件不参与演奏；
  - **单句**：点击后变黄，表示不会自动跳转至下句；再次点击后变蓝；蓝色表示会从当前句子开始自动跳转直至最后一句。
  

  - **编辑**：点击后变紫，开启后编辑小窗中第一个区块内的琴谱可以在关闭小窗后更新到原
始文本框中。
    > 请注意编辑按钮只支持小范围的改动，具体为第一行《速度》，第二行琴谱，不可以在第一行增加内容，也不可以新增行数、缩并行数。编辑模式下，左右不再触发跳转。
  - **开始**：点击后变绿，锁定跟弹和单句按钮，练习模式进入就绪状态。此时：
```text
按【1】，软件便会依据对应的模式进行演奏；无论是否选择跟弹，软件都会在对应的时间将小窗口上的文字变绿用来指示进度，这对于用户是节奏的参考。演奏中的推进速度，取决于该句句首《》内的数值与相对速度的乘积；
按【2】，中止，停留在当前句子；
按【4】，停止 0.8s，然后滑动条中的相对速度减少 0.1；
按【5】，停止 0.8s，然后滑动条中的相对速度增加 0.1。
```

  <img width="327" alt="image" src="https://github.com/user-attachments/assets/d67345b4-9a37-476e-9b3f-841bc720db03">
  
### 手弹谱的使用
右侧的三个按钮的使用依赖于琴谱中记录的时间；不带Sigma-呱呱谱中规定的延时符号无法使用。对于该类谱，用户有两个选择：
- 使用 7，8 或空格手动翻页；
- 回主界面将谱子转换为 Sigma-呱呱谱再打开练习模式。
## 流式编曲 
Sigma player v4.0 加入了流式编曲，是专业的原琴谱制作界面。本模块参考了 genshin music nightly 网站的思路，并支持了大量的新内容。
### 界面概览与操作

<img width="708" alt="image" src="https://github.com/user-attachments/assets/189a52a5-a988-4948-9461-a53309a19235" />


- 流式编曲界面由文本框副栏、瀑布流和其他 UI 构成，文本框和瀑布流的占比可以通过中间的分界线改变；列宽可以动态调整。
- 使用鼠标调整某一列的列宽，则全局会自动以新的列宽更新。例如下图：

  <img width="582" alt="image" src="https://github.com/user-attachments/assets/9ff35292-8489-4a55-8cbf-d7847a4ce198">

- 点击瀑布流栏的【列复位】，则会回到原始的列宽。
- 添加列：点击【添加列】，会跳出对话框，输入你希望添加的列数，并会在当前所在的列的右侧进行添加。
- 删除列：选中若干列，点击【删除列】，或右击表头选择【delete columns】。
### 琴谱的导入与导出
- 点击【导入】会出现如下提示词；点击确定后，会将主文本框的内容导入到瀑布流中；若是单音轨，默认为音轨 1 中导入。

  <img width="415" alt="image" src="https://github.com/user-attachments/assets/9f6cfba7-ccde-4aaa-860a-512885b5d849">

- 点击【清空】会出现如下提示词

  <img width="408" alt="image" src="https://github.com/user-attachments/assets/a0992f9f-b643-4278-9c34-b8c0e59cf0e5">

- 点击【导出】会提示导出当前音轨还是全部音轨，然后将对应内容输出至主文本框

  <img width="240" alt="image" src="https://github.com/user-attachments/assets/09177de9-e40b-4e48-842d-d792e753cf60">
### 编曲，速度与音轨
在瀑布流界面下，一个曲谱一个音轨的样子如下：

<img width="644" alt="image" src="https://github.com/user-attachments/assets/9a2b6d46-9274-4d8f-8510-5d36eee4d5f1">

- 用白色、蓝色、绿色、黄色分别代表 Sigma-呱呱谱中的+ - = ·记号；此外，我们在上、下各预留了一个八度；第一行记录速度，支持局部变速，显示逻辑和琴谱一致；第二行是标记，如果琴谱中有□记号，则在这里显示一个蓝色的色块。
- 点亮【+】按钮呈现红色后，你可以使用鼠标点击任一单元格进行曲谱的修改；若单元格是无色的，则使其变红，否则使其变为无色，并相应地修改琴谱；标记行遵循同样的逻辑，但颜色是蓝色。
- 点亮【A】按钮呈现红色后，你键盘录入的字母都会被当前选中的单元格所在的列或当前选中的列记录。
- 此外，Sigma Player 提供了**区域选择**的功能。任意选择一片区域（区域支持的类型有：用 ctrl 组合多个矩形区域和单元格，或多个连续的列，或多个连续的行），然后点击【选择】，则会将该区域的选中音符标黄。

  <img width="580" alt="image" src="https://github.com/user-attachments/assets/fa703674-ddcd-4098-b198-32e2fe868649">

  此后点击某一区域，会以绿色预览选中区域移动后的新位置。如果这符合你的要求，则
进一步点击【删除】【剪切至】或【粘贴至】。这里以剪切至为例：

  <img width="555" alt="image" src="https://github.com/user-attachments/assets/d259afaa-4bf3-46a2-b964-3ab51714661b">

  > - 黄色和绿色的显示即使切换了音轨，任意点击单元格后也会触发。
  > - 如果选择了若干列，软件会计算选中区域的起始列和结束列，并跳转到这两者的平均值位置；同时，左侧的绿色数字也会显示对应的列号，方便你进行快速定位。
- 要更改曲谱的**速度**，可以使用速度栏。如下图，选中想要修改的速度列（或该列上一格），输入速度，点击【录入】，更改选择的单元格后便会更新速度；注意，更改某一列的速度后，后续所有列都将维持这个新的速度，直到有另外标记的新速度。

  <img width="382" alt="image" src="https://github.com/user-attachments/assets/c0c39b76-ce03-4a20-b6bf-fbaa0976fa4d">

- 流式编曲功能最多支持 10 条**音轨**，每条音轨可以独立选择乐器和音量。在每条音轨中，配备了一个单选框和一个复选框。单选框决定了当前显示以及编辑的音轨；复选框决定了演奏时输出声音的那些音轨。为了保证软件不出错，所有音轨共享列节奏、速度、标记。
- 软件支持多音轨的合并显示。如果在当前位置存在其它音轨的音符，会用浅红色表示。
### 标记
- 你可以在标记行中使用【+】添加标记，或者在琴谱中对应位置添加 `□` 。在标记添加后，标记栏会实时更新标记。图中的红色方块表示当前的位置，它会实时更新。
- 点击【向前】或者【向后】，可以去到上一个或者下一个标记的位置。
- 在画布中点击，也可以依据点击的相对位置跳转到瀑布流中的位置。
  <img width="322" alt="image" src="https://github.com/user-attachments/assets/97c75709-82a4-4b47-aab3-c468dc89d69c">

### 播放、录制
选中某一位置，然后点击播放。此时如果音频输出按钮未打开，软件会向你提问是否打开；若选择打开，则会从选中位置开始播放。播放中为了降低性能压力，提供如下选项：
<img width="586" alt="image" src="https://github.com/user-attachments/assets/b97954d1-174b-40d5-b4f7-8475395e87c8">

- **进度指示**：是否需要实时选中当前正在演奏的列。
- **页面同步**：是否需要在当前列超出视图时更新视图。
- **仅标记间**：勾选后，标记画布中会短暂将播放范围边界标红，此后在范围内进行循环播放。
> - 在速度栏中，有【动态校正】按钮。打开之后，它会依据上一个音的实际演奏时长和理论时长比较，动态调整之后的演奏速度，使它趋于理论值。因此，在突然变更播放某时候，可能速度会突变，且趋于正常。尽管如此，仍然不建议将列宽设置得过小，以降低性能压力。
> - 在依赖的 Python 库 tksheet 更新到 7.0.0 后，播放流畅性大幅提升。你可以在 Sigma Player v4.26 版本起进行体验对比。
若打开【A】，则【播放】按钮会显示为【录制】。此时软件在扫过对应列时，不会演奏，而是记录键盘的输入并更新在对应位置。在使用录制功能时，我们建议将播放速度调至0.05，这样可以尽量避免节奏失真；此外，请提前插入足够数量的列，留出充足的演奏时间。原琴手弹玩家可以使用这种方式录入手弹谱，并使用流式编曲模块的丰富功能进行修改。
### 文本框
我们提供了一个文本框充当流式编曲模块的副屏。
- **撤销/重做**：最多支持 10 次；
- **<同步**：将瀑布流的内容以 Sigma-呱呱谱的形式更新在文本框中；
- **>同步**：将文本框中的 Sigma-呱呱谱更新在瀑布流上；
- **□自动**：勾选该按钮会使文本框变为不可编辑状态，且每 5 秒更新一次瀑布流的内容。选中状态下无法执行同步操作。
  
  <img width="680" alt="image" src="https://github.com/user-attachments/assets/c56ddddf-29e7-43a2-8837-570cf266817e">

  > - 我们建议你始终点选自动。如果需要微调，再关闭自动，编辑文本框，然后点击【>同步】，最后再打开自动。Sigma player 流式编曲的一大特色就是文本框和瀑布流实时互通，既可以编辑琴谱来批量修改节奏、审阅输出效果、局部修改等，又可以使用瀑布流执行区域选中、可视化，极大的提升生产力。
  > - 在 Sigma Player v4.33 版本中，支持了精确位置双向同步，让编谱体验再次上升一个台阶：点击文本框中的文本，会跳转到瀑布流的对应列；点击瀑布流的列，文本框中的对应文本也会显示为红色。你可以用这种方式更加快捷的定位到要进行修改的位置。
### 小节线
点击【+】，在速度行点击第一个小节的结束位置，即会以该节拍自动标记节奏行，并随着曲谱节奏的改动动态改变。输出琴谱时，会以斜杠输出。导入琴谱时，也会依据琴谱中的斜杠生成对应的小节线。

<img width="708" alt="image" src="https://github.com/user-attachments/assets/8eca12c1-1ad6-41c0-ad4d-0f3b818f49c2">

### 自动保存
每 5 秒，Sigma Player 会将瀑布流的内容自动保存至 `autosave/flowsave.txt` 中，你也可以重启软件，在选择琴谱中下拉【流式编曲自动保存】查看。
## Midi 转谱 
Midi 转谱是 Sigma Player Pro 的独占功能，我们精心设计了一个完整、强大而便捷的流程，可以将 Midi 文件直接转为原琴谱。

本说明书中的 Midi 文件样例均来自@文森特-Vencent。
### Midi 转谱界面概览
下图展示了 Midi 导入引导的工作流程：选择文件和转换片段-选择调式-选择黑键与节奏拟合策略-预览与导出。在软件的默认设置下，大部分情况下你只需要导入文件，然后预览更新后导出即可。如果你想要进一步精细化调整曲谱，可以将导出结果进一步导入流式编曲。

<img width="522" alt="image" src="https://github.com/user-attachments/assets/b259573e-3ac6-451c-ab6c-8761b709b246">

### 定调
点击【浏览文件】，选择想要转换的 Midi 文件，则软件会依据选区的范围，生成音域和黑键分布；此时修改选择范围，音域分布会动态地调整。如下图所示：

<img width="536" alt="image" src="https://github.com/user-attachments/assets/e3a73165-eae8-42b7-bc8c-03efa151da89">

- **音域分布**：在蓝色画布中，包含十条竖线，分别代表每个 10%的分段内，所有音符中的最高音与最低音。音调基于 Midi 文件中的 0~128 的音调范围。这个分布会随着选区的调整而改变。
> 音域分布向你指示了当前 Midi 文件与原琴音域的适配程度。如果你发现整首曲子前后的音高相差太大，可以考虑修改选择范围，分批次、采用不同的定调方案将 Midi 文件逐次导入。
- **八度选择**：软件会生成一个红色的框体，依据选择尽可能多音符的原则定下一个八度；下左图的虚线代表选择了两个额外的超出原琴音域的八度；如果不希望框选，可以点击【去掉超出音域的音】，则它会变为下右图的效果。

  在蓝色画布的上方或下方单击一次，会使框体朝对应方向平移一个八度。

  <img width="503" alt="image" src="https://github.com/user-attachments/assets/7e52d7b1-8d98-43f9-9445-2c784b6bd667">
 
- **为音轨分别选择八度**：勾选这个选项后，你可以为 Midi 文件的每一个音轨分别制定八度的策略。只需要从右下角的下拉菜单选择音轨，然后单击移动框体到指定位置即可。
- **黑键分布**：在一个八度中共有 12 个音调（do, 升 do, re, 升 re, mi, fa, 升 fa, so, 升 so, la, 升 la, ti）。游戏内乐器（除【老旧的诗琴】外）均为 C 调音源，也即不接受升的音，也即黑键的音。为此，软件会在每一个调式下，计算此时落在黑键上的音符个数，并将它们用柱状图反映在软件右侧的绿色画布上。这个分布不会随着选取的调整而改变。
- 定调：软件会依据黑键最小原则，选择一个调式，并将它标红。

  在其它调的位置单击一次，会使框体在不改变八度的情况下微调至新的调式。
  > 你可以简单地将八度选择与定调理解为粗准焦螺旋和细准焦螺旋。
### 黑键策略与节奏拟合策略
- **黑键策略**：对于当前调式下存在的黑键音符，通过【略去】、【靠上】、【靠下】进行处理。
  > 你无法知道黑键的具体位置，也无法手动逐一调整。如有需要，请在更专业的 Midi 软件中修改你的曲
谱。
- **节奏拟合策略**：与 js 谱转 Sigma-呱呱谱效果一致。采用 Sigma New-Beat 2.0 算法，拉动滑动条选择导出的曲谱更精细或是更简洁。
  > - **更精细**会使延时符号复杂化，并可能出现更多的 · 符号提升拟合精度；自动演奏时效果更还原，但可读
性会变差。推荐脚本谱作者选择这个模式。
  > - **更简洁**会使延时符号变得简洁，可读性增强，但是演奏效果可能会失真。推荐手弹玩家选择这个模式。 Midi 转谱中的节奏拟合策略无法实时查看效果，需要再次点击【预览更新】来查看效果。
### 预览、试听与导出
- **预览更新**会在导入 Midi 文件后解禁，点击后请等待进度条加载完毕，然后你可以查看导出文件的前 2000 个字符。如果你进行了任何选项的修改，需要再次点击【预览更新】。
- **播放试听**会在点击【预览更新】后激活，将调用软件内的【钢琴】音源播放预览更新的内容。
- **导出到琴谱转换**与**导出到流式编曲**会在点击【预览更新】后激活。其中，如果导出谱的字符数过多，【导出到流式编曲】按钮会替换为【导出到本地文件】。如果你点击【导出到流式编曲】没有反应，可能是因为导出谱的字符数过多，请点击【导出到琴谱转换】。
  > 在导出时，要注意对应位置的文本会被替换，请及时做好保存。
### Midi 转谱的其它注意事项
Sigma Player Pro 的 Midi 转谱具有很多的局限性，尽管它具有多音轨特性，可以满足绝大多数情形下的转谱需求。我们鼓励你使用更专业的编曲软件将 Midi 谱精修到符合原琴的音域，然后再进行转谱，以提升效率。
- Midi 转谱无法只选择指定的音轨进行输出。如果只想保留指定的音轨，请导入流式编曲后，使用区域选择功能删除不想要的音轨；如果想合并全部的音轨，请导出后将 | 替换为空。
- 你无法在 Midi 转谱的引导界面执行编辑，如有需要请在流式编曲中进一步修改。
- Midi 转谱只会识别一个 midi 文件的至多前十个音轨。
- Midi 转谱的【播放试听】只会用一个乐器合并播放全部音轨。如果你的曲谱包含了多种乐器，可在流式编曲中进一步聆听效果。
### Midi 转谱的激活资格
Midi 转谱只在 Sigma Player Pro 中开放给指定用户。我们知道诸如 [midishow.com](midishow) 网站有海量的免费资源，因此这是为了保护创作者的权益，防止被普通用户滥用于冒名投稿。

Sigma Player Pro 有着严格地申请流程，详见【欢迎使用】章节。你需要是下列类型之一：
- **Midi 制曲者**：使用更专业的编曲软件编制 Midi 文件的作者；
- **高水平手弹玩家**：需要借助 Midi 转谱获取更多联系素材的玩家；
- 其它具有同等使用价值的需求：例如，优化 Midi 文件，进一步通过改编、细节调整来适配原琴，并将琴谱公开分享。
> - 我们不接受“自用”“用着玩”等理由的 Sigma Player Pro 申请。
> - 如果我们发现 Sigma Player Pro 的用户有滥用软件的行为，会将对应的 MAC 地址上传到黑名单列表。
